{% import 'form.html.twig' as form %}

{% set displayAction = productionRequest.id ? 'displayedEdit' : 'displayedCreate' %}
{% set requiredAction = productionRequest.id ? 'requiredEdit' : 'requiredCreate' %}

{{ form.input('id', null, false, productionRequest.id, {
    type: 'hidden',
}) }}
<div class="row">
    <div class="col-6 mb-2">
        {{ form.select('type', 'Type', true, {
            type: 'productionRequestType',
            placeholder: 'Sélectionnez un type',
            search: true,
            value: productionRequest.type ? productionRequest.type.id : null,
            items: productionRequest.type ? {
                0: {
                    'value': productionRequest.type.id,
                    'label':  productionRequest.type.label,
                    'selected': true
                }
            } : null,
            additionalAttributes: productionRequest.type ? [] : [
                { name: 'onChange', value: 'onProductionRequestTypeChange($(this))' },
            ],
        }) }}
    </div>

    <div class="col-6 mb-2">
        {{ form.select('status', 'Statut', true, {
            type: 'status',
            disabled: productionRequest.type ? false : true,
            value: productionRequest.status ? productionRequest.status.id : null,
            items: productionRequest.status ? {
                0: {
                    'value': productionRequest.status.id,
                    'label':  productionRequest.status.nom,
                    'selected': true
                }
            } : null,
            includeParams: '[name=type]',
            additionalAttributes: productionRequest.type ? [] : [
                { name: 'onChange', value: 'displayAttachmentRequired($(this))' },
            ],
        }) }}
    </div>

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_MANUFACTURING_ORDER_NUMBER') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.input(fieldCode, "Numéro d'OF", requiredOnform, productionRequest.manufacturingOrderNumber) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_EMERGENCY') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.select(fieldCode, trans('Demande', 'Général', 'Urgence'), requiredOnform, {
                items: types|map(item => ({
                    value: item,
                    label: item,
                    selected: productionRequest.emergency == item,
                })),
                emptyOption: {
                    selected: not productionRequest.emergency,
                    label: trans('Demande', 'Général', 'Non urgent', false)
                }
            }) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_EXPECTED_DATE_AND_TIME') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.input(fieldCode, 'Date attendue', requiredOnform, productionRequest.expectedAt|date('Y-m-d\\TH:i'), {
                type: 'date',
            }) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_PROJECT_NUMBER') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.input(fieldCode, 'Numéro projet', requiredOnform, productionRequest.projectNumber) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_PRODUCT_ARTICLE_CODE') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.input(fieldCode, 'Code produit/article', requiredOnform, productionRequest.productArticleCode) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_QUANTITY') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.input(fieldCode, 'Quantité', requiredOnform, productionRequest.quantity, {
                type: 'number',
                min: 1,
            }) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_LINE_COUNT') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.input(fieldCode, 'Nombre de ligne', requiredOnform, productionRequest.lineCount, {
                type: 'number',
                min: 0,
            }) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_LOCATION_DROP') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.select(fieldCode, 'Emplacement de dépose', requiredOnform, {
                type: 'location',
                value: productionRequest.dropLocation ? productionRequest.dropLocation.id : null,
                items: productionRequest.dropLocation ? [{
                    value: productionRequest.dropLocation.id,
                    label: productionRequest.dropLocation.label
                }],
            }) }}
        </div>
    {% endif %}

    <!-- CHAMPS LIBRES -->
    {% set typeChampsLibres = typeChampsLibres ?? (productionRequest.type ? [{
        typeId: productionRequest.type.id,
        champsLibres: productionRequest.type.champsLibres,
    }] : []) %}
    <div class="col-12">
        <span class="toggle-collapsible expanded">{{ trans('Général', null, 'Modale', 'Champs libres') }}</span>
        <div class="collapsible expanded free-fields-container mb-2">
            {% for type in typeChampsLibres %}
                <div class="{{ typeChampsLibres|length > 1 ? ' d-none' }}"
                     data-type="{{ type.typeId }}">
                    {% include 'free_field/freeFieldsEdit.html.twig' with {
                        freeFields: type.champsLibres,
                        freeFieldValues: productionRequest.freeFields,
                        colType: 'col-md-4 col-12',
                        requiredType: 'requiredCreate',
                        actionType: 'new',
                        disabledNeeded: false,
                        needsDateFormatting: true
                    } %}
                </div>
            {% endfor %}
        </div>
    </div>

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_COMMENTAIRE') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% set requiredOnform = fieldsParam|isFieldRequired(fieldCode, requiredAction) %}
            {{ form.wysiwyg(fieldCode, trans('Général', null, 'Modale', 'Commentaire'), requiredOnform, productionRequest.comment) }}
        </div>
    {% endif %}

    {% set fieldCode = constant('App\\Entity\\Fields\\FixedFieldStandard::FIELD_CODE_ATTACHMENTS') %}
    {% set displayOnform = fieldsParam|isFieldRequired(fieldCode, displayAction) %}
    {% if displayOnform %}
        <div class="col-6 mb-2">
            {% include 'attachment/attachment.html.twig' with {
                isNew: productionRequest.id is null,
                required: false,
                override: true,
            } %}
        </div>
    {% else %}
        {{ form.hidden('isAttachmentForm', 1) }}
    {% endif %}
</div>
