{% extends 'utils/show-header.html.twig' %}

{% block showTitleTooltip ('Acheminement' ~ ' n°' ~ dispatch.number) %}
{% block showTitle trans('Demande', 'Acheminements', 'Général', 'Acheminement', false) %}
{% block showSubtitle ('n°' ~ dispatch.number) %}

{% set hasRightEdit = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::EDIT')) %}
{% set hasRightExport = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::EXPORT')) %}
{% set hasRightDelete = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::DELETE')) %}

{# droit de modification/suppression pour les acheminements brouillons #}
{% if dispatch.statut.draft %}
    {% set hasRightEdit = hasRightEdit and hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::EDIT_DRAFT_DISPATCH')) %}
    {% set hasRightDelete = hasRightDelete and hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::DELETE_DRAFT_DISPATCH')) %}
{% endif %}

{# droit de modification/suppression pour les acheminements à traiter #}
{% if not dispatch.statut.treated and not dispatch.statut.draft  %}
    {% set hasRightEdit = hasRightEdit and hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::EDIT_UNPROCESSED_DISPATCH')) %}
    {% set hasRightDelete = hasRightDelete and hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::DELETE_UNPROCESSED_DISPATCH')) %}
{% endif %}

{# droit de modification/suppression pour les acheminements traités #}
{% if dispatch.statut.treated %}
    {% set hasRightEdit = hasRightEdit and hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::EDIT_PROCESSED_DISPATCH')) %}
    {% set hasRightDelete = hasRightDelete and hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::DELETE_PROCESSED_DISPATCH')) %}
{% endif %}

{% set hasRightToGenerateDeliveryNote = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::GENERATE_DELIVERY_NOTE')) %}
{% set hasRightToGenerateOverconsumptionBill = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::GENERATE_OVERCONSUMPTION_BILL')) %}
{% set hasRightToGenerateWayBill = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::GENERATE_WAY_BILL')) %}
{% set hasRightToGenerateDispatchBill = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::GENERATE_DISPATCH_BILL')) %}

{% block showActions %}
    {% include 'utils/action-buttons/header-buttons.html.twig' with {
        forceActionButton: true,
        actions: [
            {
                hasRight: hasRightEdit and dispatch.statut.draft,
                icon: "wii-icon wii-icon-check-white",
                title:  trans('Demande', 'Acheminements', 'Détails acheminement - Entête', 'Valider la demande'),
                attributes: {
                    "data-id": dispatch ? dispatch.id,
                    "onclick": "openValidateDispatchModal()"
                }
            },
            {
                hasRight: hasRightEdit and not dispatch.statut.draft and not dispatch.statut.treated,
                icon: "wii-icon wii-icon-check-white",
                title:  trans('Demande', 'Acheminements', 'Détails acheminement - Entête', 'Terminer la demande'),
                attributes: {
                    "data-id": dispatch ? dispatch.id,
                    "onclick": "openTreatDispatchModal()"
                }
            },
            {
                hasRight: hasRightEdit and dispatch.statut.notTreated and not dispatch.statut.draft,
                icon: "fas fa-undo-alt",
                title: trans('Demande', 'Acheminements', 'Détails acheminement - Entête', 'Retour au statut Brouillon'),
                dropdownOnly: true,
                href: dispatch ? path('rollback_draft', {'dispatch': dispatch.id}),
            },
            {
                hasRight: hasRightToGenerateDeliveryNote,
                icon: "wii-icon wii-icon-printer-black",
                title: trans('Demande', 'Acheminements', 'Détails acheminement - Entête', 'Générer un bon de livraison'),
                dropdownOnly: true,
                attributes: {
                    "id": "generateDeliveryNoteButton",
                    "onclick": "openDeliveryNoteModal($(this))",
                    "data-dispatch-id": dispatch ? dispatch.id,
                }
            },
            {
                hasRight: hasRightToGenerateOverconsumptionBill,
                icon: "wii-icon wii-icon-printer-black",
                title: trans('Demande', 'Acheminements', 'Détails acheminement - Entête', 'Générer un bon de surconsommation'),
                dropdownOnly: true,
                attributes: {
                    "onclick": dispatch ? "generateOverconsumptionBill(" ~ dispatch.id ~ ")",
                },
            },
            {
                hasRight: hasRightToGenerateWayBill,
                icon: "wii-icon wii-icon-printer-black",
                title: trans('Demande', 'Acheminements', 'Détails acheminement - Entête', 'Générer une lettre de voiture'),
                dropdownOnly: true,
                attributes: {
                    "onclick": "openWaybillModal($(this))",
                    "data-dispatch-id": dispatch ? dispatch.id,
                }
            },
            {
                hasRight: hasRightToGenerateDispatchBill,
                icon: "wii-icon wii-icon-printer-black",
                title: trans('Demande', 'Acheminements', 'Détails acheminement - Entête', "Générer un bon d'acheminement"),
                dropdownOnly: true,
                attributes: {
                    "onclick": "runDispatchPrint()",
                }
            },
            {
                hasRight: hasRightEdit,
                icon: "fa fa-pen",
                title: trans('Général', null, 'Modale', 'Modifier'),
                dropdownOnly: true,
                attributes: {
                    "data-id": dispatch ? dispatch.id,
                    "data-target": '#modalEditDispatch',
                    "data-toggle": 'modal',
                    "onclick": "editRow($(this), Routing.generate('dispatch_edit_api', true), $('#modalEditDispatch'), $('#submitEditDispatch'), false, initDatePickers)"
                },
            },
            {
                hasRight: hasRightDelete,
                icon: "wii-icon wii-icon-trash-black",
                title: trans('Général', null, 'Modale', 'Supprimer'),
                dropdownOnly: true,
                attributes: {
                    "data-id": dispatch ? dispatch.id,
                    "data-target": "#modalDeleteDispatch",
                    "data-toggle": "modal",
                },
            },
        ]
    } %}
{% endblock %}

{% block showUrgence %}
    {% if dispatch.emergency %}
        <i class="fa fa-exclamation-triangle mr-2"></i>
        {{ trans('Demande', 'Acheminements', 'Détails acheminement - Entête', "Cet acheminement est urgent") }} ({{ dispatch.emergency }})
    {% endif %}
{% endblock %}
