{% set cancelledStatusesName = constant('App\\Entity\\Transport\\TransportRequest::CANCELED_STATUSES') %}
{% set requestStatusName = request.status.nom %}

{% set lastHistory = statusesHistory is not empty ? statusesHistory|last : null %}
{% set lastStatus = lastHistory ? lastHistory['status'] : null %}
{% set followingStatusIndex = lastStatus is not null ? ((statusWorkflow|flip)[lastStatus] ?? null) : 0 %}
{% set followingStatuses = followingStatusIndex is not null ? statusWorkflow|slice(followingStatusIndex + 1) : [] %}

{% for history in statusesHistory %}
    {% set state = (requestStatusName == history['status'] and requestStatusName in cancelledStatusesName)
        ? 'cancelled'
        : (history['status'] in cancelledStatusesName
            ? 'cancelled'
            : (requestStatusName == history['status'] and loop.last
                ? 'current'
                : 'past'))
    %}
    <div class="history-line">
        <div class="history-date">
            <div class="title-left {{ state }}">{{ history['status'] }}</div>
        </div>
        <div class="history-status
            {{ loop.last ? 'last-status-history'}}
            {{ loop.last and followingStatuses is empty ? 'last' }}
            {{ state }}">
            <div class="title-right {{ state }} {{ not history['date'] ? 'bg-transparent' }}">{{ history['date'] }}</div>
        </div>
    </div>
{% endfor %}

{% for followingStatus in followingStatuses %}
    {% set finishedStatusName = constant('App\\Entity\\Transport\\TransportRequest::STATUS_FINISHED') %}
    {% set estimatedAt = round ? round.estimatedAt|format_helper('longDate', {short: true, time: true}, '') : null %}
    <div class="history-line">
        <div class="history-date">
            <div class="title-left future">{{ followingStatus }}</div>
        </div>
        <div class="history-status future {{ loop.last ? 'last' }}">
            <div class="title-right {{ followingStatus == finishedStatusName ? 'future' : 'bg-transparent' }}">
                {{ followingStatus == finishedStatusName ? 'Estimé à : ' ~ (estimatedAt ?? '-') }}
            </div>
        </div>
    </div>
{% endfor %}
