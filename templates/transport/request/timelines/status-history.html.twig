{% set cancelledStatusesName = constant('App\\Entity\\Transport\\TransportRequest::CANCELED_STATUSES') %}
{% set requestStatusName = request.status.nom %}
{% set order = order ?? ((request.orders | last) ?: null) %}
{% set roundLine = order ? (order.transportRoundLines | last) ?: null : null %}

{% set lastHistory = statusesHistory is not empty ? statusesHistory|last : null %}
{% set lastStatus = lastHistory ? lastHistory['status'] : null %}
{% set followingStatusIndex = lastStatus is not null ? ((statusWorkflow|flip)[lastStatus] ?? null) : 0 %}
{% set followingStatuses = followingStatusIndex is not null ? statusWorkflow|slice(followingStatusIndex + 1) : [] %}

{% for history in statusesHistory %}
    {% set state = (requestStatusName == history['status'] and requestStatusName in cancelledStatusesName)
        ? 'cancelled'
        : (history['status'] in cancelledStatusesName
        ? 'cancelled'
        : (requestStatusName == history['status'] and loop.last
        ? 'current'
        : 'past')) %}
    <div class="history-line">
        <div class="history-date">
            <div class="title-left {{ state }}">{{ history['status'] }}</div>
        </div>
        <div class="history-status
            {{ loop.last ? 'last-status-history' }}
            {{ loop.last and followingStatuses is empty ? 'last' }}
            {{ state }}">
            <div class="title-right {{ state }} {{ not history['date'] ? 'bg-transparent' }}">{{ history['date'] }}</div>
        </div>
    </div>
{% endfor %}

{% for followingStatus in followingStatuses %}
    {% set finishedStatusName = constant('App\\Entity\\Transport\\TransportRequest::STATUS_FINISHED') %}
    {% set estimatedAt = round ? round.estimatedAt|format_helper('longDate', {short: true, time: true}, '') :
        (request.timeSlot ? request.timeSlot.name : null) %}
    <div class="history-line">
        <div class="history-date">
            <div class="title-left future">{{ followingStatus }}</div>
        </div>
        <div class="history-status future {{ loop.last ? 'last' }}">
            <div class="title-right {{ followingStatus == finishedStatusName ? 'future' : 'bg-transparent' }}">
                {% if followingStatus == finishedStatusName %}
                    {% if request is instanceof('App\\Entity\\Transport\\TransportDeliveryRequest') %}
                        {% if not order or order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_TO_ASSIGN') %}
                            Estimée à : <span class="transport-value">-</span>
                        {% elseif order.subcontracted %}
                            Estimée à : <span class="wii-big-text">Non disponible</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_ASSIGNED') %}
                            {% if prefix == 'DTR' %}
                                Estimée à : <span
                                    class="transport-value">{{ timeSlot ? timeSlot.name : request.expectedAt | date('H:i') }}</span>
                            {% else %}
                                Estimée à : <span class="transport-value">{{ request.expectedAt | date('H:i') }}</span>
                            {% endif %}
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_ONGOING') %}
                            Estimée à : <span class="transport-value">
                                {{ roundLine ? roundLine.estimatedAt | date('H:i') : '-' }}
                            </span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_FINISHED') %}
                            Faite à : <span
                                class="transport-value">{{ roundLine ? roundLine.fulfilledAt | date('H:i') : '-' }}</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_NOT_DELIVERED') %}
                            Non livrée le : <span
                                class="transport-value">{{ roundLine ? roundLine.rejectedAt | format_helper('longDate', {short: true, year: false}) : '-' }}</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_CANCELLED') %}
                            Annulée le : <span
                                class="transport-value">{{ roundLine ? roundLine.cancelledAt | format_helper('longDate', {short: true, year: false}) : '' }}</span>
                        {% endif %}
                    {% elseif request is instanceof('App\\Entity\\Transport\\TransportCollectRequest') %}
                        {% if not order or order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_TO_ASSIGN') or order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_TO_CONTACT') %}
                            Estimée à : <span class="transport-value">-</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_ASSIGNED') %}
                            Estimée à : <span class="transport-value">{{ request.timeSlot.name }}</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_ONGOING') %}
                            Estimée à : <span
                                class="transport-value">{{ roundLine ? roundLine.estimatedAt | date('H:i') : '-' }}</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_FINISHED') %}
                            Faite à : <span
                                class="transport-value">{{ roundLine ? roundLine.fulfilledAt | date('H:i') : '-' }}</span>
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_NOT_COLLECTED') %}
                            Non collectée le : {{ roundLine ? (roundLine.rejectedAt | format_helper('longDate', {short: true, year: false})) : '-' }}
                        {% elseif order.status.nom == constant('App\\Entity\\Transport\\TransportOrder::STATUS_CANCELLED') %}
                            Annulée le : <span
                                class="transport-value">{{ roundLine ? (roundLine.cancelledAt | format_helper('longDate', {short: true, year: false})) : '-' }}</span>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
{% endfor %}
