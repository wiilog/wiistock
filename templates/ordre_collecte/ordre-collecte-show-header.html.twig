{% extends 'utils/show-header.html.twig' %}

{% block showTitle ('Ordre de collecte') %}
{% block showSubtitle ('n°' ~ collecte.numero) %}

{% block showActions %}

    {% set hasRightDemandeCollecte = hasRight(constant('App\\Entity\\Menu::DEM'), constant('App\\Entity\\Action::DISPLAY_DEM_COLL')) %}
    {% set hasRightPairingOrder = hasRight(constant('App\\Entity\\Menu::ORDRE'), constant('App\\Entity\\Action::PAIR_SENSOR')) %}
    {% set hasRightDeleteOrdre = (not finished and hasRight(constant('App\\Entity\\Menu::ORDRE'), constant('App\\Entity\\Action::DELETE'))) %}
    {% set hasRightFinish = (not finished and ((collecte.utilisateur is null) or collecte.utilisateur.id == app.user.id)) %}
    {% set hasRightDropdownButton = (hasRightDemandeCollecte or hasRightDeleteOrdre) %}
    {% set canGoToHistory = (collecte.pairings|length>=1) and hasRight(constant('App\\Entity\\Menu::IOT'), constant('App\\Entity\\Action::DISPLAY_SENSOR')) %}

{# TODO ADRIEN #}
{#    {% if (collecte.ordreCollecteReferences | length + collecte.articles | length > 0) %}#}
{#        <a class=" dropdown-item pointer d-flex align-items-center"#}
{#           href="{{ path('collecte_bar_codes_print', { ordreCollecte: collecte.id }) }}">#}
{#            <span class="wii-icon wii-icon-printer-black print-button mr-2"></span>#}
{#            Imprimer les étiquettes#}
{#        </a>#}

{#    {% endif %}#}

    {% include 'utils/action-buttons/header-buttons.html.twig' with {
        forceActionButton: true,
        actions: [
            {
                hasRight: hasRightFinish,
                buttonClass: ( hasRightDemandeCollecte or hasRightDeleteOrdre ) ? 'split-button',
                icon: "wii-icon wii-icon-check-white",
                title: "Finir la collecte",
                attributes: {
                    "onclick":  collecte.demandeCollecte.stock
                        ? "Select2Old.location($('.ajax-autocomplete-location')); checkIfRowSelected(openLocationModal);"
                        : "checkIfRowSelected(() => finishCollecte($(this), true))",
                },
            },
            {
                hasRight: hasRightDropdownButton and hasRightDemandeCollecte,
                icon: "wii-icon wii-icon-printer-black",
                title: "Imprimer les étiquettes",
                dropdownOnly: true,
                attributes: {
                    "onclick": "printCollecteBarCodes()",
                }
            },
            {
                hasRight: hasRightDropdownButton and canGoToHistory,
                icon: "wii-icon wii-icon-pairing",
                title: "Historique des données",
                dropdownOnly: true,
                href: path('show_data_history', {id: collecte.id, type: constant('App\\Entity\\IOT\\Sensor::COLLECT_ORDER')}),
            },
            {
                hasRight: hasRightDropdownButton and hasRightDeleteOrdre and collecte.activePairing,
                buttonClass: "disabled",
                icon: "wii-icon wii-icon-trash-black",
                title: "Supprimer",
                dropdownOnly: true,
                attributes: {
                    "disabled": true,
                    "style": "pointer-events: initial",
                    "title": "La collecte est associée à un capteur, il faut d'abord la dissocier de son capteur",
                },
            },
            {
                hasRight: hasRightDropdownButton and hasRightDeleteOrdre and not collecte.activePairing,
                icon: "wii-icon wii-icon-trash-black",
                title: "Supprimer",
                href: "",
                dropdownOnly: true,
                attributes: {
                    "onclick": "deleteRow($(this), $('#modalDeleteOrdreCollecte'), $('#submitDeleteOrdreCollecte'))",
                    "data-id": collecte ? collecte.id,
                    "data-target": "#modalDeleteOrdreCollecte",
                    "data-toggle": "modal",
                },
            },
            {
                hasRight: hasRightDropdownButton and hasRightDeleteOrdre and hasRightPairingOrder and hasRightFinish and not collecte.activePairing and collecte.demandeCollecte.stock,
                icon: "wii-icon wii-icon-pairing",
                title: "Associer à un capteur",
                href: "",
                dropdownOnly: true,
                attributes: {
                    "data-target": "#modalNewSensorPairing",
                    "data-toggle": "modal",
                },
            },
        ]
    } %}
{% endblock %}
